<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Convert Encoding in JavaScript</title>
<link rel="shortcut icon" href="http://api.polygonpla.net/img/icon/house.png">
<script type="text/javascript" async="async" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" async="async" src="https://github.com/polygonplanet/Unzipper.js/raw/master/src/encoding.js"></script>
<script>
setTimeout(function() {
  'use strict';

  var done;
  var ENCODINGS = ['SJIS', 'JIS', 'EUCJP', 'UTF8'];

  void function loadback() {
    if (typeof $ === 'undefined' ||
        typeof Encoding === 'undefined') {
      setTimeout(loadback, 32);

    } else if (!done) {
      done = true;
      doit();
    }
  }();


  function doit() {
    $('.run').click(convert);
  }


  function arrayToString(data) {
    return String.fromCharCode.apply(String, data);
  }


  function convert() {
    var d = $.Deferred();

    $.each(ENCODINGS, function(k, type) {
      d.done(function() {
        var fileName = 'encoding-' + type.toLowerCase() + '.txt';

        return request(fileName).then(function(bytes) {
          appendText('Open ', '.', fileName);
          appendText(bytes.toString(), fileName + ' (' + type + ' Array)');
          appendText(arrayToString(bytes), fileName + ' (' + type + ' String)');

          // Convert to Unicode.
          var encoded = Encoding.convert(bytes, 'UTF16');

          appendText(encoded, fileName + ' (' + type + ' => UTF-16 Array)');
          appendText(arrayToString(encoded), fileName + ' (' + type + ' => UTF-16 String)');
        });
      });
    });
    d.resolve();
  }


  function request(url) {
    var d = $.Deferred();
    var xhr = window.ActiveXObject ? new ActiveXObject('Microsoft.XMLHTTP')
                                   : new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.overrideMimeType('text/plain; charset=x-user-defined');
    // or xhr.responseType = 'arraybuffer';
    xhr.onreadystatechange = function(ev) {
      if (this.readyState === 4 && this.status === 200) {
        var bin = this.responseText;
        var bytes = [];
        for (var i = 0, len = bin.length; i < len; i++) {
          var c = bin.charCodeAt(i);
          bytes[bytes.length] = c & 0xFF;
        }
        d.resolve(bytes);
      }
    };
    xhr.send(null);
    return d;
  }


  function appendText(text, title, url) {
    var target = $('#container');
    if (url) {
      $('<h3/>')
        .append(text)
        .append(
          $('<a/>')
            .attr({
              href   : url,
              target : '_blank'
            })
            .text(url)
        )
        .append(title)
        .appendTo(target);
    } else {
      $('<div/>').text(title).appendTo(target);
      $('<textarea/>').val(text).appendTo(target);
    }
  }


}, 200);
</script>
<style>
textarea {
  width: 98%;
  height: 2.5em;
}

#container {
  margin: 1em;
}

.run {
  font-size: 120%;
  font-weight: bold;
}

#footer {
  margin: 0.5em auto;
  text-align: center;
}
</style>
</head>
<body>
<h1>Convert Encoding in JavaScript</h1>
<h2>文字コードを変換します</h2>
<p>
 いろいろな文字コードで書かれているテキストを取得して
 文字コードを変換して表示します。
</p>

<div>
 <button type="button" class="run">Run</button>
</div>

<div id="container"></div>

<p id="footer">
 Last modified: 2012-07-28
 Written by <a href="http://twitter.com/polygon_planet" title="Twitter @polygon_planet" target="_blank">polygon planet</a>
 <a href="https://github.com/polygonplanet/Unzipper.js" title="polygonplanet/Unzipper.js - GitHub">GitHub</a>
</p>

</body>
</html>